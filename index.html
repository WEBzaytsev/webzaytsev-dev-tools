<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Port Generator</title>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary-color: #0070f3;
			--error-color: #ff4444;
			--success-color: #00c853;
			--border-color: #eaeaea;
			--text-color: #333;
			--bg-color: #fafafa;
			--card-bg: #ffffff;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: var(--bg-color);
			color: var(--text-color);
			line-height: 1.6;
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 1rem;
		}

		.container {
			width: 100%;
			max-width: 480px;
			background: var(--card-bg);
			padding: 2rem;
			border-radius: 12px;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
		}

		h2 {
			font-size: 1.75rem;
			font-weight: 700;
			margin-bottom: 1.5rem;
			color: #000;
		}

		.input-group {
			margin-bottom: 1.5rem;
		}

		label {
			display: block;
			margin-bottom: 0.5rem;
			font-weight: 500;
			font-size: 0.875rem;
		}

		input[type="number"] {
			width: 100%;
			padding: 0.75rem;
			border: 1px solid var(--border-color);
			border-radius: 8px;
			font-size: 1rem;
			transition: border-color 0.2s;
			outline: none;
		}

		input[type="number"]:focus {
			border-color: var(--primary-color);
		}

		.checkbox-group {
			margin: 1.5rem 0;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		input[type="checkbox"] {
			width: 1.25rem;
			height: 1.25rem;
			border-radius: 4px;
			cursor: pointer;
		}

		button {
			width: 100%;
			padding: 0.75rem;
			border: none;
			border-radius: 8px;
			background: var(--primary-color);
			color: white;
			font-size: 1rem;
			font-weight: 500;
			cursor: pointer;
			transition: opacity 0.2s;
		}

		button:hover {
			opacity: 0.9;
		}

		#result {
			margin-top: 1.5rem;
			padding: 1rem;
			border-radius: 8px;
			background: #f7f7f7;
			font-size: 1rem;
			text-align: center;
		}

		#result.error {
			background: #fff5f5;
			color: var(--error-color);
		}

		#copyButton {
			margin-top: 1rem;
			background: #fff;
			color: var(--primary-color);
			border: 1px solid var(--primary-color);
		}

		#notification {
			margin-top: 1rem;
			text-align: center;
			color: var(--success-color);
			font-size: 0.875rem;
		}

		@media (max-width: 480px) {
			.container {
				padding: 1.5rem;
			}
		}
	</style>
</head>

<body>
	<div class="container">
		<h2>Port Generator</h2>

		<div class="input-group">
			<label for="minPortInput">Минимальный порт</label>
			<input type="number" id="minPortInput" value="10024">
		</div>

		<div class="input-group">
			<label for="maxPortInput">Максимальный порт</label>
			<input type="number" id="maxPortInput" value="60000">
		</div>

		<div class="checkbox-group">
			<input type="checkbox" id="rangeCheckbox">
			<label for="rangeCheckbox">Генерировать диапазон</label>
		</div>

		<div class="input-group" id="rangeField" style="display: none;">
			<label for="rangeInput">Размер диапазона</label>
			<input type="number" id="rangeInput">
		</div>

		<button id="generateButton">Сгенерировать порт</button>
		<p id="result"></p>
		<button id="copyButton" style="display: none;">Копировать</button>
		<p id="notification"></p>
	</div>

	<script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>
		const DEFAULT_MIN_PORT = 10024;
		const DEFAULT_MAX_PORT = 60000;
		const usedPortsKey = 'usedPorts';

		// DOM Elements
		const minPortInput = document.getElementById('minPortInput');
		const maxPortInput = document.getElementById('maxPortInput');
		const rangeCheckbox = document.getElementById('rangeCheckbox');
		const rangeField = document.getElementById('rangeField');
		const rangeInput = document.getElementById('rangeInput');
		const resultElement = document.getElementById('result');
		const generateButton = document.getElementById('generateButton');
		const copyButton = document.getElementById('copyButton');
		const notificationElement = document.getElementById('notification');

		// Event Listeners
		document.addEventListener('DOMContentLoaded', () => {
			rangeCheckbox.addEventListener('change', () => {
				rangeField.style.display = rangeCheckbox.checked ? 'block' : 'none';
			});

			generateButton.addEventListener('click', generatePort);
			copyButton.addEventListener('click', copyToClipboard);

			copyButton.style.display = 'none';
			notificationElement.style.display = 'none';
		});

		// Port Management Functions
		function loadUsedPorts() {
			const usedPortsJson = localStorage.getItem(usedPortsKey);
			return usedPortsJson ? new Set(JSON.parse(usedPortsJson)) : new Set();
		}

		function saveUsedPorts(usedPorts) {
			localStorage.setItem(usedPortsKey, JSON.stringify([...usedPorts]));
		}

		function generateUniqueStartPort(usedPorts, increment, minPort, maxPort) {
			let attempts = 0;
			const maxAttempts = 1000; // Предотвращение бесконечного цикла

			while (attempts < maxAttempts) {
				const startPort = Math.floor(Math.random() * (maxPort - minPort - increment + 1)) + minPort;
				let isUnique = true;

				for (let i = 0; i <= increment; i++) {
					if (usedPorts.has(startPort + i)) {
						isUnique = false;
						break;
					}
				}

				if (isUnique) return startPort;
				attempts++;
			}

			throw new Error("Не удалось найти свободный порт после " + maxAttempts + " попыток");
		}

		function showResult(message, isError = false) {
			resultElement.textContent = message;
			resultElement.className = isError ? 'error' : '';
			copyButton.style.display = isError ? 'none' : 'inline-block';
		}

		function generatePort() {
			try {
				const minPort = parseInt(minPortInput.value, 10) || DEFAULT_MIN_PORT;
				const maxPort = parseInt(maxPortInput.value, 10) || DEFAULT_MAX_PORT;

				if (minPort < 1000 || maxPort > 65535 || minPort >= maxPort) {
					throw new Error("Недопустимый диапазон портов");
				}

				const usedPorts = loadUsedPorts();

				if (rangeCheckbox.checked) {
					const increment = parseInt(rangeInput.value, 10);
					
					if (isNaN(increment) || increment <= 0) {
						throw new Error("Размер диапазона должен быть положительным числом");
					}

					const startPort = generateUniqueStartPort(usedPorts, increment, minPort, maxPort);
					const endPort = startPort + increment;

					for (let port = startPort; port <= endPort; port++) {
						usedPorts.add(port);
					}

					saveUsedPorts(usedPorts);
					showResult(`Сгенерирован диапазон портов: ${startPort}-${endPort}`);
				} else {
					const newPort = generateUniqueStartPort(usedPorts, 0, minPort, maxPort);
					usedPorts.add(newPort);
					saveUsedPorts(usedPorts);
					showResult(`Сгенерирован порт: ${newPort}`);
				}
			} catch (error) {
				showResult(error.message, true);
			}
		}

		function copyToClipboard() {
			const resultText = resultElement.textContent;
			const match = resultText.match(/\d+(-\d+)?/);
			
			if (match) {
				navigator.clipboard.writeText(match[0])
					.then(() => {
						notificationElement.textContent = "Скопировано в буфер обмена";
						notificationElement.style.display = 'block';
						setTimeout(() => {
							notificationElement.style.display = 'none';
						}, 2000);
					})
					.catch(err => {
						console.error('Ошибка копирования:', err);
						notificationElement.textContent = "Ошибка при копировании";
						notificationElement.style.display = 'block';
					});
			}
		}
	</script>
</body>

</html>